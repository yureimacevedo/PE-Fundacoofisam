<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FUNDACOOFISAM - PlaneaciÃ³n EstratÃ©gica</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#1F2937}.loading{display:flex;justify-content:center;align-items:center;height:100vh;color:white;font-size:1.5rem}.auth-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}.auth-box{background:white;border-radius:16px;padding:2rem;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3)}.auth-header{text-align:center;margin-bottom:2rem}.auth-header h1{font-size:1.75rem;color:#4F46E5;margin-bottom:0.5rem}.form-group{margin-bottom:1.5rem}.form-group label{display:block;margin-bottom:0.5rem;font-weight:600;color:#374151}.form-group input,.form-group select,.form-group textarea{width:100%;padding:0.75rem;border:2px solid #E5E7EB;border-radius:8px;font-size:1rem}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#4F46E5}.btn-primary{width:100%;padding:0.875rem;border:none;background:linear-gradient(135deg,#4F46E5 0%,#7C3AED 100%);color:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;margin-bottom:1rem}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(79,70,229,0.3)}.btn-primary:disabled{opacity:0.5;cursor:not-allowed}.btn-secondary{padding:0.75rem 1.5rem;border:2px solid #E5E7EB;background:white;color:#6B7280;border-radius:8px;font-weight:600;cursor:pointer;margin-right:0.5rem}.btn-secondary:hover{border-color:#4F46E5;color:#4F46E5}.btn-edit{padding:0.5rem 1rem;border:2px solid #4F46E5;background:white;color:#4F46E5;border-radius:6px;font-weight:600;cursor:pointer;font-size:0.875rem;margin-right:0.5rem}.btn-edit:hover{background:#4F46E5;color:white}.error-message{background:#FEE2E2;color:#991B1B;padding:0.75rem;border-radius:8px;margin-bottom:1rem;font-size:0.875rem}.app-container{display:flex;min-height:100vh}.sidebar{width:280px;background:rgba(255,255,255,0.95);display:flex;flex-direction:column;box-shadow:4px 0 24px rgba(0,0,0,0.08)}.sidebar-header{padding:2rem 1.5rem;background:linear-gradient(135deg,#4F46E5 0%,#7C3AED 100%);color:white}.sidebar-header h2{font-size:1.5rem;font-weight:700}.sidebar-header p{font-size:0.875rem;opacity:0.9;margin-top:0.25rem}.user-info{padding:1rem 1.5rem;background:#F9FAFB;border-bottom:1px solid #E5E7EB;font-size:0.875rem}.user-email{color:#4F46E5;font-weight:600;margin-bottom:0.5rem}.btn-logout{padding:0.5rem 1rem;background:white;border:2px solid #E5E7EB;border-radius:6px;cursor:pointer;font-size:0.875rem;width:100%}.nav-items{flex:1;padding:1rem 0}.nav-item{width:100%;padding:1rem 1.5rem;border:none;background:none;display:flex;align-items:center;gap:0.75rem;cursor:pointer;color:#4B5563;font-size:1rem;border-left:3px solid transparent;text-align:left}.nav-item:hover:not(:disabled){background:#F3F4F6;color:#4F46E5}.nav-item.activo{background:rgba(79,70,229,0.1);color:#4F46E5;font-weight:600;border-left-color:#4F46E5}.nav-item:disabled{opacity:0.4;cursor:not-allowed}.main-content{flex:1;padding:2rem;overflow-y:auto;background:#F9FAFB}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem}.page-header h1{font-size:2rem;font-weight:800;color:#111827}.card{background:white;border-radius:12px;padding:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:1.5rem}.card h3{font-size:1.25rem;font-weight:700;color:#111827;margin-bottom:1rem}.card h4{font-size:1.1rem;font-weight:600;color:#374151;margin-bottom:0.5rem}.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem}.stat-card{background:white;border-radius:12px;padding:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);border-left:4px solid #4F46E5}.stat-label{font-size:0.875rem;color:#6B7280;margin-bottom:0.5rem;text-transform:uppercase;font-weight:600}.stat-value{font-size:2.5rem;font-weight:800;color:#111827}.semaforo{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;border-radius:8px;font-size:0.875rem;font-weight:600}.semaforo.critico{background:#FEE2E2;color:#991B1B}.semaforo.precaucion{background:#FEF3C7;color:#92400E}.semaforo.optimo{background:#D1FAE5;color:#065F46}.tabla{width:100%;border-collapse:collapse}.tabla th{background:#F9FAFB;padding:1rem;text-align:left;font-weight:700;color:#374151;font-size:0.875rem}.tabla td{padding:1rem;border-top:1px solid #E5E7EB}.tabla tr:hover{background:#F9FAFB}.badge{display:inline-block;padding:0.25rem 0.75rem;border-radius:12px;font-size:0.75rem;font-weight:700}.empty-state{text-align:center;padding:4rem 2rem;color:#6B7280}.empty-state h3{font-size:1.5rem;color:#111827;margin:1rem 0}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;padding:1rem}.modal{background:white;border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)}.modal-header{padding:1.5rem;border-bottom:1px solid #E5E7EB;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#4F46E5 0%,#7C3AED 100%);color:white;border-radius:16px 16px 0 0}.modal-header h2{font-size:1.5rem;font-weight:700}.btn-cerrar{background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:6px;cursor:pointer;font-size:1.5rem;line-height:1}.modal-body{padding:1.5rem}.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}.btn-group{display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap}@media print{.sidebar,.page-header button,.btn-primary,.btn-secondary,.btn-edit{display:none!important}.main-content{padding:1rem}.app-container{display:block}}@media(max-width:768px){.sidebar{width:100%}.app-container{flex-direction:column}.grid{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}}
.informe-dashboard{padding:1.5rem}
@media print{
  .informe-dashboard h1{font-size:1.4rem;color:#1F2937;border-bottom:3px solid #4F46E5;padding-bottom:0.5rem;margin-bottom:1rem}
  .informe-dashboard .ind-block{margin-bottom:2rem;break-inside:avoid;page-break-inside:avoid}
  .informe-dashboard .ind-header{background:#4F46E5;color:white;padding:0.6rem 1rem;border-radius:8px 8px 0 0;display:grid;grid-template-columns:1fr auto;gap:1rem;align-items:center}
  .informe-dashboard .ind-subheader{background:#EEF2FF;padding:0.4rem 1rem;font-size:0.8rem;color:#4F46E5;display:flex;gap:1.5rem;flex-wrap:wrap}
  .informe-dashboard table{width:100%;border-collapse:collapse;font-size:0.82rem}
  .informe-dashboard th{background:#F9FAFB;padding:0.5rem 0.75rem;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #E5E7EB}
  .informe-dashboard td{padding:0.5rem 0.75rem;border-bottom:1px solid #F3F4F6}
  .informe-dashboard .fila-total{background:#F9FAFB;font-weight:700;border-top:2px solid #E5E7EB}
  .informe-dashboard .s-optimo{color:#065F46;font-weight:700}
  .informe-dashboard .s-precaucion{color:#92400E;font-weight:700}
  .informe-dashboard .s-critico{color:#991B1B;font-weight:700}
  .informe-dashboard .resumen-general{background:#F9FAFB;padding:1rem;border-radius:8px;margin-bottom:1.5rem;display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center}
  .informe-dashboard .res-item{padding:0.5rem}
  .informe-dashboard .res-val{font-size:1.8rem;font-weight:800;color:#4F46E5}
  .informe-dashboard .res-lbl{font-size:0.75rem;color:#6B7280;text-transform:uppercase;font-weight:600}
  .informe-dashboard .entidad-info{margin-bottom:1rem;color:#6B7280;font-size:0.85rem}
  .informe-dashboard .barra-avance{height:8px;background:#E5E7EB;border-radius:4px;overflow:hidden;width:80px;display:inline-block;vertical-align:middle;margin-left:0.4rem}
  .informe-dashboard .barra-fill{height:100%;background:#4F46E5;border-radius:4px}
}

.print-only{display:none}
@media print{
  .print-only{display:block!important}
  .no-print{display:none!important}
  .sidebar,.page-header button,.btn-primary,.btn-secondary,.btn-edit,.btn-gantt,.btn-cerrar{display:none!important}
  .main-content{padding:0!important}
  .app-container{display:block!important}
  body{background:white!important}
  .informe-print{padding:2rem}
  .informe-print h1{font-size:1.5rem;color:#1F2937;border-bottom:3px solid #4F46E5;padding-bottom:0.5rem;margin-bottom:1.5rem}
  .informe-print .eje-block{margin-bottom:2rem;break-inside:avoid}
  .informe-print .eje-titulo{background:#4F46E5;color:white;padding:0.75rem 1rem;border-radius:8px;font-size:1.1rem;font-weight:700;margin-bottom:0.75rem}
  .informe-print .objetivo-block{margin-left:1rem;margin-bottom:1rem;border-left:3px solid #E5E7EB;padding-left:1rem}
  .informe-print .objetivo-titulo{font-weight:700;color:#374151;margin-bottom:0.5rem;font-size:0.95rem}
  .informe-print .indicador-row{display:grid;grid-template-columns:2fr 1fr 2fr;gap:0.5rem;padding:0.5rem;background:#F9FAFB;border-radius:6px;margin-bottom:0.4rem;font-size:0.85rem}
  .informe-print .indicador-nombre{font-weight:600;color:#111827}
  .informe-print .indicador-meta{color:#4F46E5;font-weight:600}
  .informe-print .indicador-anios{color:#6B7280;font-size:0.8rem}
  .informe-print .header-cols{display:grid;grid-template-columns:2fr 1fr 2fr;gap:0.5rem;padding:0.25rem 0.5rem;font-size:0.75rem;font-weight:700;color:#6B7280;text-transform:uppercase;margin-bottom:0.25rem}
  .informe-print .entidad-info{margin-bottom:1.5rem;color:#6B7280;font-size:0.9rem}
  .informe-print .badge-tipo{display:inline-block;padding:0.15rem 0.5rem;border-radius:10px;font-size:0.7rem;font-weight:700;margin-left:0.5rem}
  .informe-print .asc{background:#D1FAE5;color:#065F46}
  .informe-print .desc{background:#FEE2E2;color:#991B1B}
}
.btn-gantt{padding:0.5rem 1rem;border:2px solid #7C3AED;background:white;color:#7C3AED;border-radius:6px;font-weight:600;cursor:pointer;font-size:0.875rem;margin-right:0.5rem}.btn-gantt:hover{background:#7C3AED;color:white}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect}=React;
const firebaseConfig={apiKey:"AIzaSyAudtZnoZuRtbEDJ8Am-7XgDBDsqTTdU68",authDomain:"plan-estrategico-50ab9.firebaseapp.com",projectId:"plan-estrategico-50ab9",storageBucket:"plan-estrategico-50ab9.firebasestorage.app",messagingSenderId:"708927732803",appId:"1:708927732803:web:b55ff91c7649e93cf0e8f6"};
if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
const imprimirInforme=()=>{window.print();};

const App=()=>{const[user,setUser]=useState(null);const[userRol,setUserRol]=useState(null);const[loading,setLoading]=useState(true);useEffect(()=>{const unsub=auth.onAuthStateChanged(async(u)=>{setUser(u);if(u){const doc=await db.collection('fundacoofisam_usuarios').doc(u.uid).get();if(doc.exists)setUserRol(doc.data().rol||'admin');else setUserRol('admin');}else{setUserRol(null);}setLoading(false);});return()=>unsub();},[]);if(loading)return <div className="loading">â³ Cargando...</div>;if(!user)return <AuthScreen/>;return <MainApp user={user} userRol={userRol}/>;};

const AuthScreen=()=>{const[isLogin,setIsLogin]=useState(true);const[email,setEmail]=useState('');const[password,setPassword]=useState('');const[error,setError]=useState('');const[loading,setLoading]=useState(false);const handleSubmit=async(e)=>{e.preventDefault();setError('');setLoading(true);try{if(isLogin)await auth.signInWithEmailAndPassword(email,password);else{const cred=await auth.createUserWithEmailAndPassword(email,password);const snap=await db.collection('fundacoofisam_usuarios').get();const rolNuevo=snap.empty?'admin':'seguimiento';await db.collection('fundacoofisam_usuarios').doc(cred.user.uid).set({email:email,nombre:'',rol:rolNuevo,entidadId:'general',createdAt:firebase.firestore.FieldValue.serverTimestamp()});}}catch(err){setError(err.message);}finally{setLoading(false);}};return(<div className="auth-container"><div className="auth-box"><div className="auth-header"><h1>ğŸ¯ PlaneaciÃ³n EstratÃ©gica</h1><p>{isLogin?'Inicia sesiÃ³n':'Crea tu cuenta'}</p></div>{error&&<div className="error-message">âš ï¸ {error}</div>}<form onSubmit={handleSubmit}><div className="form-group"><label>Email</label><input type="email" value={email} onChange={(e)=>setEmail(e.target.value)} required/></div><div className="form-group"><label>ContraseÃ±a</label><input type="password" value={password} onChange={(e)=>setPassword(e.target.value)} required/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³':(isLogin?'ğŸ” Entrar':'ğŸ“ Crear Cuenta')}</button></form><div style={{textAlign:'center',fontSize:'0.875rem',color:'#6B7280'}}>{isLogin?'Â¿No tienes cuenta? ':'Â¿Ya tienes cuenta? '}<button onClick={()=>setIsLogin(!isLogin)} style={{background:'none',border:'none',color:'#4F46E5',fontWeight:600,cursor:'pointer',textDecoration:'underline'}}>{isLogin?'RegÃ­strate':'Inicia sesiÃ³n'}</button></div></div></div>);};

const MainApp=({user,userRol})=>{const isAdmin=userRol==='admin'||userRol===null;const[vista,setVista]=useState('fundacoofisam_entidades');const[fundacoofisam_entidades,setEntidades]=useState([]);const[entidadActiva,setEntidadActiva]=useState(null);const[datos,setDatos]=useState(null);useEffect(()=>{if(!user)return;const u=db.collection('fundacoofisam_entidades').onSnapshot((s)=>{const ents=[];s.forEach((doc)=>ents.push({id:doc.id,...doc.data()}));setEntidades(ents);if(entidadActiva){const act=ents.find(e=>e.id===entidadActiva.id);if(act)setEntidadActiva(act);}});return()=>u();},[user]);useEffect(()=>{if(!entidadActiva||!user){setDatos(null);return;}const ref=db.collection('fundacoofisam_entidades').doc(entidadActiva.id);const unsubs=[ref.collection('ejes').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,ejes:d}));}),ref.collection('objetivos').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,objetivos:d}));}),ref.collection('indicadores').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,indicadores:d}));}),ref.collection('seguimientos').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,seguimientos:d}));})];return()=>unsubs.forEach(u=>u());},[entidadActiva,user]);return(<div className="app-container"><nav className="sidebar"><div className="sidebar-header"><h2>FUNDACOOFISAM</h2><p style={{fontSize:'0.875rem',opacity:0.9}}>Multi-Entidad</p></div><div className="selector-entidad"><select value={entidadActiva?.id||''} onChange={(e)=>setEntidadActiva(fundacoofisam_entidades.find(en=>en.id===e.target.value)||null)}><option value="">Seleccionar...</option>{fundacoofisam_entidades.map(e=><option key={e.id} value={e.id}>{e.nombre}</option>)}</select></div><div className="user-info"><div className="user-email">ğŸ‘¤ {user.email}</div><div style={{fontSize:'0.75rem',marginBottom:'0.5rem',padding:'0.25rem 0.5rem',borderRadius:'6px',display:'inline-block',background:isAdmin?'#EDE9FE':'#D1FAE5',color:isAdmin?'#6D28D9':'#065F46',fontWeight:700}}>{isAdmin?'ğŸ”‘ Admin':'ğŸ“ Seguimiento'}</div><button className="btn-logout" onClick={()=>{if(window.confirm('Â¿Cerrar sesiÃ³n?'))auth.signOut();}}>ğŸšª Cerrar</button></div><div className="nav-items"><button className={`nav-item ${vista==='fundacoofisam_entidades'?'activo':''}`} onClick={()=>setVista('fundacoofisam_entidades')}>ğŸ¢ Entidades</button><button className={`nav-item ${vista==='dashboard'?'activo':''}`} onClick={()=>setVista('dashboard')} disabled={!entidadActiva}>ğŸ“Š Dashboard</button><button className={`nav-item ${vista==='config'?'activo':''}`} onClick={()=>setVista('config')} disabled={!entidadActiva}>ğŸ“‹ PlaneaciÃ³n</button><button className={`nav-item ${vista==='planOperativo'?'activo':''}`} onClick={()=>setVista('planOperativo')} disabled={!entidadActiva}>ğŸ—“ï¸ Plan Operativo</button>{isAdmin&&<button className={`nav-item ${vista==='usuarios'?'activo':''}`} onClick={()=>setVista('usuarios')} disabled={!entidadActiva}>ğŸ‘¥ Usuarios</button>}<button className={`nav-item ${vista==='seguimiento'?'activo':''}`} onClick={()=>setVista('seguimiento')} disabled={!entidadActiva}>ğŸ“ Seguimiento</button></div></nav><main className="main-content">{vista==='fundacoofisam_entidades'&&<VistaEntidades user={user} fundacoofisam_entidades={fundacoofisam_entidades} entidadActiva={entidadActiva}/>}{vista==='dashboard'&&<VistaDashboard entidad={entidadActiva} datos={datos}/>}{vista==='config'&&<VistaConfig user={user} entidad={entidadActiva} datos={datos} isAdmin={isAdmin}/>}{vista==='usuarios'&&isAdmin&&<VistaUsuarios user={user} userRol={userRol} entidad={entidadActiva}/>}{vista==='planOperativo'&&<VistaPlanOperativo user={user} entidad={entidadActiva} datos={datos}/>}{vista==='seguimiento'&&<VistaSeguimiento user={user} entidad={entidadActiva} datos={datos}/>}</main></div>);};

const VistaEntidades=({user,fundacoofisam_entidades,entidadActiva})=>{const[modal,setModal]=useState(null);const[form,setForm]=useState({});const[itemEdit,setItemEdit]=useState(null);const[loading,setLoading]=useState(false);const guardar=async(e)=>{e.preventDefault();setLoading(true);try{const scoreConfig={critico:{min:0,max:parseFloat(form.criticoMax||60),color:'#DC2626',label:'CrÃ­tico'},precaucion:{min:parseFloat(form.precaucionMin||61),max:parseFloat(form.precaucionMax||85),color:'#F59E0B',label:'PrecauciÃ³n'},optimo:{min:parseFloat(form.optimoMin||86),max:100,color:'#059669',label:'Ã“ptimo'}};const data={nombre:form.nombre,nit:form.nit,periodo:form.periodo,vision:form.vision||'',scoreConfig};if(itemEdit){await db.collection('fundacoofisam_entidades').doc(itemEdit.id).update(data);}else{await db.collection('fundacoofisam_entidades').add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()});}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const eliminar=async(id)=>{if(!window.confirm('Â¿Eliminar entidad y todos sus datos?'))return;try{await db.collection('fundacoofisam_entidades').doc(id).delete();}catch(error){alert('Error: '+error.message);}};const editarEntidad=(ent)=>{setItemEdit(ent);setForm({nombre:ent.nombre,nit:ent.nit,periodo:ent.periodo,vision:ent.vision||'',criticoMax:ent.scoreConfig?.critico?.max||60,precaucionMin:ent.scoreConfig?.precaucion?.min||61,precaucionMax:ent.scoreConfig?.precaucion?.max||85,optimoMin:ent.scoreConfig?.optimo?.min||86});setModal('entidad');};return(<div><div className="page-header"><h1>Mis Entidades</h1><button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({nombre:'',nit:'',periodo:'',vision:'',criticoMax:'60',precaucionMin:'61',precaucionMax:'85',optimoMin:'86'});setModal('entidad');}}>+ Nueva Entidad</button></div><div className="grid">{fundacoofisam_entidades.length===0?(<div className="empty-state"><h3>ğŸ¢ No hay fundacoofisam_entidades</h3><p>Crea tu primera entidad</p></div>):(fundacoofisam_entidades.map(ent=>(<div key={ent.id} className="card" style={{borderLeft:entidadActiva?.id===ent.id?'4px solid #4F46E5':'4px solid transparent'}}><h3>{ent.nombre}</h3><p style={{color:'#6B7280',marginBottom:'0.5rem'}}>NIT: {ent.nit}</p><div className="badge" style={{background:'#4F46E5',color:'white',marginBottom:'0.5rem'}}>{ent.periodo}</div>{ent.vision&&<p style={{color:'#4F46E5',fontSize:'0.875rem',marginBottom:'0.5rem'}}>ğŸ¯ {ent.vision}</p>}{ent.scoreConfig&&(<p style={{color:'#059669',fontSize:'0.75rem',marginTop:'0.5rem'}}>Score: 0-{ent.scoreConfig.critico.max}% ğŸ”´ | {ent.scoreConfig.precaucion.min}-{ent.scoreConfig.precaucion.max}% ğŸŸ¡ | {ent.scoreConfig.optimo.min}%+ ğŸŸ¢</p>)}<div className="btn-group"><button className="btn-edit" onClick={()=>editarEntidad(ent)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar(ent.id)}>ğŸ—‘ï¸ Eliminar</button></div></div>)))}</div>{modal==='entidad'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nueva'} Entidad</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardar}><div className="form-group"><label>Nombre *</label><input type="text" value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required/></div><div className="form-group"><label>NIT *</label><input type="text" value={form.nit} onChange={e=>setForm({...form,nit:e.target.value})} required/></div><div className="form-group"><label>Periodo *</label><input type="text" value={form.periodo} onChange={e=>setForm({...form,periodo:e.target.value})} required placeholder="2025-2027"/></div><div className="form-group"><label>VisiÃ³n</label><textarea value={form.vision} onChange={e=>setForm({...form,vision:e.target.value})} rows={3}/></div><div className="card" style={{background:'#FEF3C7',marginBottom:'1rem'}}><h4 style={{color:'#92400E',marginBottom:'0.5rem'}}>âš™ï¸ ConfiguraciÃ³n de Score (Global)</h4><div className="form-row"><div className="form-group"><label>ğŸ”´ CrÃ­tico: 0% hasta</label><input type="number" value={form.criticoMax} onChange={e=>setForm({...form,criticoMax:e.target.value})} required/></div><div className="form-group"><label>ğŸŸ¡ PrecauciÃ³n: desde</label><input type="number" value={form.precaucionMin} onChange={e=>setForm({...form,precaucionMin:e.target.value})} required/></div></div><div className="form-row"><div className="form-group"><label>ğŸŸ¡ PrecauciÃ³n: hasta</label><input type="number" value={form.precaucionMax} onChange={e=>setForm({...form,precaucionMax:e.target.value})} required/></div><div className="form-group"><label>ğŸŸ¢ Ã“ptimo: desde</label><input type="number" value={form.optimoMin} onChange={e=>setForm({...form,optimoMin:e.target.value})} required/></div></div><small style={{color:'#92400E'}}>Este score se aplicarÃ¡ a TODOS los indicadores de esta entidad</small></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³ Guardando...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}</div>);};

const VistaDashboard=({entidad,datos})=>{const[modalAnual,setModalAnual]=useState(false);const[anioInforme,setAnioInforme]=useState(new Date().getFullYear().toString());if(!entidad||!datos)return <div className="empty-state"><h3>Selecciona una entidad</h3></div>;const{ejes=[],objetivos=[],indicadores=[],seguimientos=[]}=datos;const periodos=[...new Set(seguimientos.map(s=>`${s.mes} ${s.anio}`))].sort((a,b)=>{const[mesA,anioA]=a.split(' ');const[mesB,anioB]=b.split(' ');const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];if(anioA!==anioB)return parseInt(anioA)-parseInt(anioB);return meses.indexOf(mesA)-meses.indexOf(mesB);});const ultimoPeriodo=periodos[periodos.length-1];const seguimientosUltimo=seguimientos.filter(s=>`${s.mes} ${s.anio}`===ultimoPeriodo);const porScore={critico:0,precaucion:0,optimo:0};seguimientosUltimo.forEach(s=>{if(s.score)porScore[s.score]++;});const indicadoresConEstado=indicadores.map(ind=>{const ultSeg=seguimientos.filter(s=>s.indicadorId===ind.id).sort((a,b)=>{const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];if(a.anio!==b.anio)return parseInt(b.anio)-parseInt(a.anio);return meses.indexOf(b.mes)-meses.indexOf(a.mes);})[0];const obj=objetivos.find(o=>o.id===ind.objetivoId);const eje=ejes.find(e=>e.id===obj?.ejeId);return{...ind,ultimoSeguimiento:ultSeg,objetivo:obj,eje:eje};});return(<div><div className="page-header"><div><h1>Dashboard - {entidad.nombre}</h1><p style={{color:'#6B7280'}}>{entidad.periodo}</p></div><div style={{display:'flex',gap:'0.5rem',alignItems:'center'}}><select value={anioInforme} onChange={e=>setAnioInforme(e.target.value)} style={{padding:'0.5rem',borderRadius:'6px',border:'2px solid #E5E7EB'}}>{['2024','2025','2026','2027'].map(a=><option key={a} value={a}>{a}</option>)}</select><button className="btn-primary" style={{width:'auto'}} onClick={()=>setModalAnual(true)}>ğŸ–¨ï¸ Informe Anual</button></div></div><div className="grid"><div className="stat-card"><div className="stat-label">Ejes</div><div className="stat-value">{ejes.length}</div></div><div className="stat-card"><div className="stat-label">Indicadores</div><div className="stat-value">{indicadores.length}</div></div><div className="stat-card" style={{borderLeftColor:'#059669'}}><div className="stat-label">Ã“ptimos</div><div className="stat-value">{porScore.optimo}</div></div><div className="stat-card" style={{borderLeftColor:'#F59E0B'}}><div className="stat-label">PrecauciÃ³n</div><div className="stat-value">{porScore.precaucion}</div></div><div className="stat-card" style={{borderLeftColor:'#DC2626'}}><div className="stat-label">CrÃ­ticos</div><div className="stat-value">{porScore.critico}</div></div></div>{modalAnual&&<ModalImpresionDashboard entidad={entidad} datos={datos} anioSeleccionado={anioInforme} onClose={()=>setModalAnual(false)}/>}{indicadoresConEstado.length>0&&(<div className="card"><h3>ğŸ“Š Estado de Indicadores ({ultimoPeriodo||'Sin datos'})</h3><table className="tabla"><thead><tr><th>Eje</th><th>Indicador</th><th>Meta</th><th>Avance</th><th>Rendimiento</th><th>Estado</th></tr></thead><tbody>{indicadoresConEstado.map(ind=>(<tr key={ind.id}><td><div className="badge" style={{background:ind.eje?.color||'#6B7280',color:'white'}}>{ind.eje?.nombre||'-'}</div></td><td><strong>{ind.nombre}</strong></td><td>{ind.ultimoSeguimiento?`${ind.ultimoSeguimiento.metaAnual||ind.meta} ${ind.unidad}`:'-'}</td><td>{ind.ultimoSeguimiento?`${ind.ultimoSeguimiento.avance} ${ind.unidad}`:'-'}</td><td>{ind.ultimoSeguimiento?<strong>{ind.ultimoSeguimiento.rendimiento.toFixed(2)}%</strong>:'-'}</td><td>{ind.ultimoSeguimiento?<div className={`semaforo ${ind.ultimoSeguimiento.score}`}>{ind.ultimoSeguimiento.score==='critico'&&'ğŸ”´'}{ind.ultimoSeguimiento.score==='precaucion'&&'ğŸŸ¡'}{ind.ultimoSeguimiento.score==='optimo'&&'ğŸŸ¢'}</div>:'-'}</td></tr>))}</tbody></table></div>)}</div>);};

const VistaConfig=({user,entidad,datos,isAdmin})=>{const[modalPrint,setModalPrint]=useState(false);const[modal,setModal]=useState(null);const[form,setForm]=useState({});const[itemEdit,setItemEdit]=useState(null);const[loading,setLoading]=useState(false);if(!entidad||!datos)return <div className="empty-state"><h3>Selecciona una entidad</h3></div>;const{ejes=[],objetivos=[],indicadores=[]}=datos;const ref=db.collection('fundacoofisam_entidades').doc(entidad.id);const scoreConfig=entidad.scoreConfig||{critico:{min:0,max:60},precaucion:{min:61,max:85},optimo:{min:86,max:100}};const guardarEje=async(e)=>{e.preventDefault();setLoading(true);try{if(itemEdit){await ref.collection('ejes').doc(itemEdit.id).update(form);}else{await ref.collection('ejes').add(form);}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const guardarObjetivo=async(e)=>{e.preventDefault();setLoading(true);try{if(itemEdit){await ref.collection('objetivos').doc(itemEdit.id).update(form);}else{await ref.collection('objetivos').add(form);}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const guardarIndicador=async(e)=>{e.preventDefault();setLoading(true);try{const metasPorAnio={};if(form.anios){form.anios.split(',').forEach(a=>{const anio=a.trim();if(anio)metasPorAnio[anio]=parseFloat(form[`meta_${anio}`]||form.meta);});}const data={objetivoId:form.objetivoId,nombre:form.nombre,tipo:form.tipo,periodicidad:form.periodicidad,meta:parseFloat(form.meta),unidad:form.unidad,estrategia:form.estrategia||'',metasPorAnio};if(itemEdit){await ref.collection('indicadores').doc(itemEdit.id).update(data);}else{await ref.collection('indicadores').add(data);}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const eliminar=async(coleccion,id)=>{if(!window.confirm('Â¿Eliminar?'))return;try{await ref.collection(coleccion).doc(id).delete();}catch(error){alert('Error: '+error.message);}};const editarEje=(eje)=>{setItemEdit(eje);setForm({nombre:eje.nombre,color:eje.color});setModal('eje');};const editarObjetivo=(obj)=>{setItemEdit(obj);setForm({ejeId:obj.ejeId,nombre:obj.nombre});setModal('objetivo');};const editarIndicador=(ind)=>{setItemEdit(ind);const anios=ind.metasPorAnio?Object.keys(ind.metasPorAnio).join(','):'';const formData={objetivoId:ind.objetivoId,nombre:ind.nombre,tipo:ind.tipo,periodicidad:ind.periodicidad,meta:ind.meta,unidad:ind.unidad,estrategia:ind.estrategia||'',anios};if(ind.metasPorAnio){Object.entries(ind.metasPorAnio).forEach(([anio,meta])=>{formData[`meta_${anio}`]=meta;});}setForm(formData);setModal('indicador');};return(<div><div className="page-header"><h1>PlaneaciÃ³n - {entidad.nombre}</h1><button className="btn-secondary" onClick={()=>setModalPrint(true)}>ğŸ–¨ï¸ Imprimir PlaneaciÃ³n</button></div><div className="card"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}><h3>Ejes EstratÃ©gicos ({ejes.length})</h3>{isAdmin&&<button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({nombre:'',color:'#4F46E5'});setModal('eje');}}>+ Nuevo Eje</button>}</div>{ejes.length===0?<p style={{color:'#6B7280'}}>No hay ejes</p>:<div className="grid">{ejes.map(eje=>(<div key={eje.id} className="card" style={{borderLeft:`4px solid ${eje.color}`}}><h4>{eje.nombre}</h4>{isAdmin&&<div className="btn-group"><button className="btn-edit" onClick={()=>editarEje(eje)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar('ejes',eje.id)}>ğŸ—‘ï¸ Eliminar</button></div>}</div>))}</div>}</div><div className="card"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}><h3>Objetivos ({objetivos.length})</h3>{isAdmin&&<button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({ejeId:'',nombre:''});setModal('objetivo');}} disabled={ejes.length===0}>+ Nuevo Objetivo</button>}}</div>{objetivos.length===0?<p style={{color:'#6B7280'}}>No hay objetivos</p>:objetivos.map(obj=>{const eje=ejes.find(e=>e.id===obj.ejeId);return(<div key={obj.id} className="card" style={{borderLeft:`4px solid ${eje?.color||'#6B7280'}`}}><div className="badge" style={{background:eje?.color,color:'white',marginBottom:'0.5rem'}}>{eje?.nombre||'Sin eje'}</div><p>{obj.nombre}</p>{isAdmin&&<div className="btn-group"><button className="btn-edit" onClick={()=>editarObjetivo(obj)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar('objetivos',obj.id)}>ğŸ—‘ï¸ Eliminar</button></div>}</div>);})}</div><div className="card"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}><h3>Indicadores ({indicadores.length})</h3>{isAdmin&&<button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({objetivoId:'',nombre:'',tipo:'ascendente',periodicidad:'Mensual',meta:'',unidad:'%',estrategia:'',anios:''});setModal('indicador');}} disabled={objetivos.length===0}>+ Nuevo Indicador</button>}</div>{indicadores.length===0?<p style={{color:'#6B7280'}}>No hay indicadores</p>:<div className="grid">{indicadores.map(ind=>{const obj=objetivos.find(o=>o.id===ind.objetivoId);const eje=ejes.find(e=>e.id===obj?.ejeId);return(<div key={ind.id} className="card" style={{borderLeft:`4px solid ${eje?.color||'#6B7280'}`}}><div className="badge" style={{background:eje?.color,color:'white',marginBottom:'0.5rem'}}>{eje?.nombre}</div><h4>{ind.nombre}</h4><p style={{color:'#6B7280',fontSize:'0.875rem',marginTop:'0.5rem'}}>Meta: {ind.meta} {ind.unidad} | {ind.tipo==='ascendente'?'ğŸ“ˆ':'ğŸ“‰'}</p>{ind.metasPorAnio&&Object.keys(ind.metasPorAnio).length>0&&(<p style={{color:'#4F46E5',fontSize:'0.75rem',marginTop:'0.25rem'}}>Metas: {Object.entries(ind.metasPorAnio).map(([a,m])=>`${a}:${m}`).join(', ')}</p>)}{isAdmin&&<div className="btn-group"><button className="btn-edit" onClick={()=>editarIndicador(ind)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar('indicadores',ind.id)}>ğŸ—‘ï¸ Eliminar</button></div>}</div>);})}</div>}</div>{modalPrint&&<ModalImpresionPlaneacion entidad={entidad} datos={datos} onClose={()=>setModalPrint(false)}/>}{modal==='eje'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nuevo'} Eje</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardarEje}><div className="form-group"><label>Nombre *</label><input type="text" value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required/></div><div className="form-group"><label>Color</label><input type="color" value={form.color} onChange={e=>setForm({...form,color:e.target.value})}/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}{modal==='objetivo'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nuevo'} Objetivo</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardarObjetivo}><div className="form-group"><label>Eje *</label><select value={form.ejeId} onChange={e=>setForm({...form,ejeId:e.target.value})} required><option value="">Seleccionar...</option>{ejes.map(e=><option key={e.id} value={e.id}>{e.nombre}</option>)}</select></div><div className="form-group"><label>Nombre *</label><textarea value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required rows={3}/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}{modal==='indicador'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nuevo'} Indicador</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardarIndicador}><div className="form-group"><label>Objetivo *</label><select value={form.objetivoId} onChange={e=>setForm({...form,objetivoId:e.target.value})} required><option value="">Seleccionar...</option>{objetivos.map(obj=>{const eje=ejes.find(e=>e.id===obj.ejeId);return<option key={obj.id} value={obj.id}>[{eje?.nombre}] {obj.nombre}</option>;})}</select></div><div className="form-group"><label>Nombre *</label><input type="text" value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required/></div><div className="form-row"><div className="form-group"><label>Tipo *</label><select value={form.tipo} onChange={e=>setForm({...form,tipo:e.target.value})} required><option value="ascendente">ğŸ“ˆ Ascendente</option><option value="descendente">ğŸ“‰ Descendente</option></select></div><div className="form-group"><label>Periodicidad *</label><select value={form.periodicidad} onChange={e=>setForm({...form,periodicidad:e.target.value})} required><option value="Mensual">Mensual</option><option value="Bimestral">Bimestral</option><option value="Trimestral">Trimestral</option><option value="Semestral">Semestral</option><option value="Anual">Anual</option></select></div></div><div className="form-row"><div className="form-group"><label>Meta Base *</label><input type="number" step="0.01" value={form.meta} onChange={e=>setForm({...form,meta:e.target.value})} required/></div><div className="form-group"><label>Unidad *</label><input type="text" value={form.unidad} onChange={e=>setForm({...form,unidad:e.target.value})} required placeholder="%"/></div></div><div className="form-group"><label>AÃ±os con Metas EspecÃ­ficas</label><input type="text" value={form.anios} onChange={e=>setForm({...form,anios:e.target.value})} placeholder="2025,2026,2027"/><small style={{color:'#6B7280',display:'block',marginTop:'0.25rem'}}>Separados por coma</small></div>{form.anios&&form.anios.split(',').map(a=>{const anio=a.trim();if(!anio)return null;return(<div key={anio} className="form-group"><label>Meta para {anio}</label><input type="number" step="0.01" value={form[`meta_${anio}`]||form.meta} onChange={e=>setForm({...form,[`meta_${anio}`]:e.target.value})}/></div>);})}<div className="form-group"><label>Estrategia</label><textarea value={form.estrategia} onChange={e=>setForm({...form,estrategia:e.target.value})} rows={3}/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}</div>);};


const colorEstado=(e)=>{if(e==='completado')return{bg:'#D1FAE5',color:'#065F46'};if(e==='en_proceso')return{bg:'#DBEAFE',color:'#1E40AF'};if(e==='cancelado')return{bg:'#FEE2E2',color:'#991B1B'};return{bg:'#F3F4F6',color:'#374151'};};
const labelEstado=(e)=>{if(e==='completado')return'âœ… Completado';if(e==='en_proceso')return'ğŸ”„ En Proceso';if(e==='cancelado')return'âŒ Cancelado';return'â³ Pendiente';};



const VistaPlanOperativo=({user,entidad,datos})=>{
const[objetivoSel,setObjetivoSel]=useState('');
const[anioSel,setAnioSel]=useState(new Date().getFullYear().toString());
const[busqueda,setBusqueda]=useState('');
const[vistaGantt,setVistaGantt]=useState(false);
const[modal,setModal]=useState(false);
const[form,setForm]=useState({});
const[itemEdit,setItemEdit]=useState(null);
const[loading,setLoading]=useState(false);
const[actividades,setActividades]=useState([]);

useEffect(()=>{
if(!entidad||!objetivoSel)return;
const ref=db.collection('fundacoofisam_entidades').doc(entidad.id).collection('plan_operativo');
const unsub=ref.where('objetivoId','==',objetivoSel).where('anio','==',anioSel).onSnapshot(s=>{
const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));
d.sort((a,b)=>new Date(a.fechaInicio)-new Date(b.fechaInicio));
setActividades(d);
});
return()=>unsub();
},[entidad,objetivoSel,anioSel,user]);

if(!entidad||!datos)return <div className="empty-state"><h3>Selecciona entidad</h3></div>;
const{ejes=[],objetivos=[],indicadores=[]}=datos;

const formVacio={objetivoId:objetivoSel,anio:anioSel,actividad:'',tarea:'',responsable:'',meta:'',presupuesto:'',fechaInicio:'',fechaFin:'',avance:0,estado:'pendiente',observaciones:''};

const guardar=async(e)=>{
e.preventDefault();setLoading(true);
try{
const data={...form,avance:parseInt(form.avance||0),presupuesto:parseFloat(form.presupuesto||0)};
const ref=db.collection('fundacoofisam_entidades').doc(entidad.id).collection('plan_operativo');
if(itemEdit){await ref.doc(itemEdit.id).update(data);}
else{await ref.add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()});}
setModal(false);setForm({});setItemEdit(null);
}catch(err){alert('Error: '+err.message);}
finally{setLoading(false);}};

const eliminar=async(id)=>{if(!window.confirm('Â¿Eliminar?'))return;
await db.collection('fundacoofisam_entidades').doc(entidad.id).collection('plan_operativo').doc(id).delete();};

const editar=(act)=>{setItemEdit(act);setForm({...act});setModal(true);};

const objetivoActual=objetivos.find(o=>o.id===objetivoSel);
const ejeActual=ejes.find(e=>e.id===objetivoActual?.ejeId);
const indsObjetivo=indicadores.filter(i=>i.objetivoId===objetivoSel);

const totalPresupuesto=actividades.reduce((s,a)=>s+(parseFloat(a.presupuesto)||0),0);
const completadas=actividades.filter(a=>a.estado==='completado').length;
const avancePromedio=actividades.length>0?Math.round(actividades.reduce((s,a)=>s+(a.avance||0),0)/actividades.length):0;

const objetivosFiltrados=objetivos.filter(o=>{
const eje=ejes.find(e=>e.id===o.ejeId);
return(o.nombre+' '+(eje?.nombre||'')).toLowerCase().includes(busqueda.toLowerCase());
});

// Gantt
const todasFechas=actividades.filter(a=>a.fechaInicio&&a.fechaFin);
const minFecha=todasFechas.length>0?new Date(Math.min(...todasFechas.map(a=>new Date(a.fechaInicio)))):new Date();
const maxFecha=todasFechas.length>0?new Date(Math.max(...todasFechas.map(a=>new Date(a.fechaFin)))):new Date();
const totalDias=Math.max(1,Math.ceil((maxFecha-minFecha)/(1000*60*60*24)))+1;
const getPct=(f)=>Math.max(0,Math.ceil((new Date(f)-minFecha)/(1000*60*60*24)))/totalDias*100;
const getAncho=(fi,ff)=>Math.max(2,Math.ceil((new Date(ff)-new Date(fi))/(1000*60*60*24))/totalDias*100);

const colorEstado=(e)=>{if(e==='completado')return{bg:'#D1FAE5',color:'#065F46'};if(e==='en_proceso')return{bg:'#DBEAFE',color:'#1E40AF'};if(e==='cancelado')return{bg:'#FEE2E2',color:'#991B1B'};return{bg:'#F3F4F6',color:'#374151'};};
const labelEstado=(e)=>{if(e==='completado')return'âœ… Completado';if(e==='en_proceso')return'ğŸ”„ En Proceso';if(e==='cancelado')return'âŒ Cancelado';return'â³ Pendiente';};

return(<div>
<div className="page-header">
<h1>ğŸ“‹ Plan Operativo Anual</h1>
<div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap',alignItems:'center'}}>
{objetivoSel&&<><button className="btn-secondary" onClick={()=>setVistaGantt(!vistaGantt)}>{vistaGantt?'ğŸ“‹ Tabla':'ğŸ“Š Gantt'}</button>
<button className="btn-secondary" onClick={imprimirInforme}>ğŸ–¨ï¸ Imprimir</button>
<button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({...formVacio});setModal(true);}}>+ Nueva Actividad</button></>}
</div>
</div>

{/* Selector objetivo + aÃ±o */}
<div className="card">
<div className="form-row">
<div className="form-group">
<label>ğŸ” Buscar Objetivo</label>
<input type="text" value={busqueda} onChange={e=>setBusqueda(e.target.value)} placeholder="Escribe para filtrar..." style={{marginBottom:'0.5rem'}}/>
<select value={objetivoSel} onChange={e=>setObjetivoSel(e.target.value)}
size={Math.min(6,objetivosFiltrados.length+1)} style={{height:'auto',minHeight:'80px'}}>
<option value="">-- Seleccionar objetivo --</option>
{objetivosFiltrados.map(obj=>{
const eje=ejes.find(e=>e.id===obj.ejeId);
return<option key={obj.id} value={obj.id}>[{eje?.nombre}] {obj.nombre}</option>;
})}
</select>
</div>
<div className="form-group">
<label>ğŸ“… AÃ±o del POA</label>
<select value={anioSel} onChange={e=>setAnioSel(e.target.value)}
style={{padding:'0.75rem',border:'2px solid #E5E7EB',borderRadius:'8px',fontSize:'1rem',width:'100%'}}>
{['2024','2025','2026','2027','2028'].map(a=><option key={a} value={a}>{a}</option>)}
</select>
{objetivoActual&&(
<div style={{marginTop:'1rem',background:ejeActual?.color?ejeActual.color+'22':'#EEF2FF',padding:'0.75rem',borderRadius:'8px',borderLeft:`4px solid ${ejeActual?.color||'#4F46E5'}`}}>
<div style={{fontWeight:700,color:ejeActual?.color||'#4F46E5',fontSize:'0.8rem',marginBottom:'0.25rem'}}>ğŸ¯ {ejeActual?.nombre}</div>
<div style={{fontSize:'0.875rem',color:'#374151'}}>{objetivoActual.nombre}</div>
{indsObjetivo.length>0&&<div style={{fontSize:'0.75rem',color:'#6B7280',marginTop:'0.4rem'}}>ğŸ“Š {indsObjetivo.length} indicador{indsObjetivo.length!==1?'es':''}: {indsObjetivo.map(i=>i.nombre).join(', ')}</div>}
</div>
)}
</div>
</div>
</div>

{/* Stats */}
{objetivoSel&&actividades.length>0&&(
<div className="grid" style={{gridTemplateColumns:'repeat(4,1fr)'}}>
<div className="stat-card"><div className="stat-label">Actividades</div><div className="stat-value">{actividades.length}</div></div>
<div className="stat-card" style={{borderLeftColor:'#059669'}}><div className="stat-label">Completadas</div><div className="stat-value">{completadas}</div></div>
<div className="stat-card" style={{borderLeftColor:'#F59E0B'}}><div className="stat-label">Avance Prom.</div><div className="stat-value">{avancePromedio}%</div></div>
<div className="stat-card" style={{borderLeftColor:'#7C3AED'}}><div className="stat-label">Presupuesto</div><div className="stat-value" style={{fontSize:'1.3rem'}}>${totalPresupuesto.toLocaleString()}</div></div>
</div>
)}

{/* Sin selecciÃ³n */}
{!objetivoSel&&<div className="empty-state"><h3>Selecciona un objetivo para ver su POA</h3><p>Usa el buscador para encontrarlo rÃ¡pido</p></div>}

{/* Vista Tabla */}
{objetivoSel&&!vistaGantt&&(
<div className="card">
<h3>ğŸ“‹ Actividades {anioSel}</h3>
{actividades.length===0?<div className="empty-state" style={{padding:'2rem'}}><h3>Sin actividades</h3><p>Click en "+ Nueva Actividad" para comenzar</p></div>:
<div style={{overflowX:'auto'}}><table className="tabla">
<thead><tr><th>Actividad</th><th>Tarea</th><th>Responsable</th><th>Meta</th><th>Fechas</th><th>Presupuesto</th><th>Avance</th><th>Estado</th><th>Observaciones</th><th></th></tr></thead>
<tbody>{actividades.map(act=>{const est=colorEstado(act.estado);return(
<tr key={act.id}>
<td><strong>{act.actividad}</strong></td>
<td style={{fontSize:'0.875rem'}}>{act.tarea}</td>
<td>ğŸ‘¤ {act.responsable}</td>
<td>{act.meta}</td>
<td style={{whiteSpace:'nowrap',fontSize:'0.8rem'}}>
{act.fechaInicio&&<div>ğŸ“… {act.fechaInicio}</div>}
{act.fechaFin&&<div>ğŸ {act.fechaFin}</div>}
</td>
<td>${(parseFloat(act.presupuesto)||0).toLocaleString()}</td>
<td>
<div style={{display:'flex',alignItems:'center',gap:'0.4rem'}}>
<div style={{width:'60px',background:'#E5E7EB',borderRadius:'4px',height:'8px'}}>
<div style={{width:`${act.avance||0}%`,background:'#4F46E5',height:'8px',borderRadius:'4px'}}></div>
</div>
<span style={{fontSize:'0.8rem',fontWeight:'bold'}}>{act.avance||0}%</span>
</div>
</td>
<td><span style={{padding:'0.2rem 0.5rem',borderRadius:'6px',fontSize:'0.75rem',fontWeight:700,background:est.bg,color:est.color}}>{labelEstado(act.estado)}</span></td>
<td style={{maxWidth:'140px',fontSize:'0.8rem',color:'#6B7280'}}>{act.observaciones}</td>
<td style={{whiteSpace:'nowrap'}}>
<button className="btn-edit" onClick={()=>editar(act)}>âœï¸</button>
<button className="btn-secondary" style={{padding:'0.4rem 0.6rem'}} onClick={()=>eliminar(act.id)}>ğŸ—‘ï¸</button>
</td>
</tr>);})}</tbody>
</table></div>}
</div>)}

{/* Vista Gantt */}
{objetivoSel&&vistaGantt&&(
<div className="card">
<h3>ğŸ“Š Cronograma Gantt {anioSel}</h3>
{todasFechas.length===0?<p style={{color:'#6B7280'}}>No hay actividades con fechas definidas</p>:(
<div style={{overflowX:'auto'}}><div style={{minWidth:'700px'}}>
<div style={{display:'grid',gridTemplateColumns:'220px 1fr',marginBottom:'0.5rem'}}>
<div style={{fontWeight:700,color:'#374151',fontSize:'0.8rem',padding:'0.5rem'}}>Actividad</div>
<div style={{position:'relative',height:'28px'}}>
{[0,25,50,75,100].map(p=><div key={p} style={{position:'absolute',left:`${p}%`,top:0,bottom:0,borderLeft:'1px dashed #E5E7EB',paddingLeft:'2px',fontSize:'0.7rem',color:'#9CA3AF'}}>{p}%</div>)}
</div>
</div>
{todasFechas.map(act=>{const est=colorEstado(act.estado);const izq=getPct(act.fechaInicio);const ancho=getAncho(act.fechaInicio,act.fechaFin);return(
<div key={act.id} style={{display:'grid',gridTemplateColumns:'220px 1fr',marginBottom:'0.4rem',alignItems:'center'}}>
<div style={{padding:'0.4rem',fontSize:'0.8rem',fontWeight:600,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}} title={act.actividad}>{act.actividad}</div>
<div style={{position:'relative',height:'28px',background:'#F9FAFB',borderRadius:'4px'}}>
<div style={{position:'absolute',left:`${izq}%`,width:`${ancho}%`,height:'100%',background:est.bg,border:`2px solid ${est.color}`,borderRadius:'4px',display:'flex',alignItems:'center',justifyContent:'center',minWidth:'35px'}}>
<span style={{fontSize:'0.7rem',fontWeight:700,color:est.color,padding:'0 3px'}}>{act.avance||0}%</span>
</div>
</div>
</div>);})}
<div style={{marginTop:'1rem',padding:'0.6rem 0.75rem',background:'#F9FAFB',borderRadius:'6px',fontSize:'0.8rem',color:'#6B7280'}}>
ğŸ“… {minFecha.toLocaleDateString()} â†’ {maxFecha.toLocaleDateString()} ({totalDias} dÃ­as)
</div>
</div></div>)}
</div>)}

{/* Modal */}
{modal&&(<div className="modal-overlay" onClick={()=>setModal(false)}>
<div className="modal" onClick={e=>e.stopPropagation()}>
<div className="modal-header">
<h2>{itemEdit?'Editar':'Nueva'} Actividad - {anioSel}</h2>
<button className="btn-cerrar" onClick={()=>setModal(false)}>Ã—</button>
</div>
<div className="modal-body">
{objetivoActual&&<div style={{background:'#EEF2FF',padding:'0.75rem',borderRadius:'8px',marginBottom:'1rem',fontSize:'0.875rem',color:'#4F46E5',borderLeft:`4px solid ${ejeActual?.color||'#4F46E5'}`}}>
<strong>{ejeActual?.nombre}</strong> â†’ {objetivoActual.nombre}
</div>}
<form onSubmit={guardar}>
<div className="form-row">
<div className="form-group"><label>AÃ±o *</label>
<select value={form.anio||anioSel} onChange={e=>setForm({...form,anio:e.target.value})}>
{['2024','2025','2026','2027','2028'].map(a=><option key={a} value={a}>{a}</option>)}
</select></div>
<div className="form-group"><label>Estado</label>
<select value={form.estado||'pendiente'} onChange={e=>setForm({...form,estado:e.target.value})}>
<option value="pendiente">â³ Pendiente</option>
<option value="en_proceso">ğŸ”„ En Proceso</option>
<option value="completado">âœ… Completado</option>
<option value="cancelado">âŒ Cancelado</option>
</select></div>
</div>
<div className="form-group"><label>Actividad *</label><input type="text" value={form.actividad||''} onChange={e=>setForm({...form,actividad:e.target.value})} required placeholder="Nombre de la actividad"/></div>
<div className="form-group"><label>Tarea</label><input type="text" value={form.tarea||''} onChange={e=>setForm({...form,tarea:e.target.value})} placeholder="DescripciÃ³n de la tarea"/></div>
<div className="form-row">
<div className="form-group"><label>Responsable *</label><input type="text" value={form.responsable||''} onChange={e=>setForm({...form,responsable:e.target.value})} required placeholder="Nombre del responsable"/></div>
<div className="form-group"><label>Meta de la Actividad</label><input type="text" value={form.meta||''} onChange={e=>setForm({...form,meta:e.target.value})} placeholder="Ej: 100% ejecuciÃ³n"/></div>
</div>
<div className="form-row">
<div className="form-group"><label>Fecha Inicio *</label><input type="date" value={form.fechaInicio||''} onChange={e=>setForm({...form,fechaInicio:e.target.value})} required/></div>
<div className="form-group"><label>Fecha Fin *</label><input type="date" value={form.fechaFin||''} onChange={e=>setForm({...form,fechaFin:e.target.value})} required/></div>
</div>
<div className="form-row">
<div className="form-group"><label>Presupuesto ($)</label><input type="number" step="0.01" value={form.presupuesto||''} onChange={e=>setForm({...form,presupuesto:e.target.value})} placeholder="0"/></div>
<div className="form-group"><label>% Avance: <strong>{form.avance||0}%</strong></label>
<input type="range" min="0" max="100" step="5" value={form.avance||0} onChange={e=>setForm({...form,avance:parseInt(e.target.value)})} style={{width:'100%',marginTop:'0.5rem'}}/></div>
</div>
<div className="form-group"><label>Observaciones</label><textarea value={form.observaciones||''} onChange={e=>setForm({...form,observaciones:e.target.value})} rows={3} placeholder="Notas, comentarios..."/></div>
<button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar Actividad'}</button>
</form></div></div></div>)}
</div>);};

const VistaUsuarios=({user,userRol,entidad})=>{
  const[usuarios,setUsuarios]=useState([]);
  const[modal,setModal]=useState(false);
  const[form,setForm]=useState({email:'',password:'',rol:'seguimiento',nombre:''});
  const[loading,setLoading]=useState(false);
  const[mensaje,setMensaje]=useState({texto:'',tipo:''});

  const prefijo='fundacoofisam';

  useEffect(()=>{
    if(!entidad)return;
    const unsub=db.collection(`${prefijo}_usuarios`)
      .where('entidadId','==','general')
      .onSnapshot(s=>{
        const d=[];
        s.forEach(doc=>d.push({id:doc.id,...doc.data()}));
        d.sort((a,b)=>(a.nombre||a.email).localeCompare(b.nombre||b.email));
        setUsuarios(d);
      });
    return()=>unsub();
  },[entidad]);

  const crearUsuario=async(e)=>{
    e.preventDefault();
    setLoading(true);
    setMensaje({texto:'',tipo:''});
    try{
      // App secundaria para no desloguear al admin
      const _appSec=firebase.initializeApp(firebase.app().options,'sec'+Date.now());
      const _authSec=_appSec.auth();
      const cred=await _authSec.createUserWithEmailAndPassword(form.email,form.password);
      await db.collection(`${prefijo}_usuarios`).doc(cred.user.uid).set({
        email:form.email,
        nombre:form.nombre||form.email,
        rol:form.rol,
        entidadId:'general',
        creadoPor:user.uid,
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });
      await _authSec.signOut();
      await _appSec.delete();
      setMensaje({texto:`âœ… Usuario ${form.email} creado. Ya puede ingresar.`,tipo:'ok'});
      setForm({email:'',password:'',rol:'seguimiento',nombre:''});
    }catch(err){
      setMensaje({texto:'âŒ '+err.message,tipo:'error'});
    }finally{
      setLoading(false);
    }
  };

  const cambiarRol=async(uid,nuevoRol)=>{
    try{
      await db.collection(`${prefijo}_usuarios`).doc(uid).update({rol:nuevoRol});
      setMensaje({texto:'âœ… Rol actualizado',tipo:'ok'});
      setTimeout(()=>setMensaje({texto:'',tipo:''}),2000);
    }catch(err){
      setMensaje({texto:'âŒ '+err.message,tipo:'error'});
    }
  };

  const eliminarUsuario=async(uid,emailUsu)=>{
    if(!window.confirm(`Â¿Eliminar acceso de ${emailUsu}?`))return;
    try{
      await db.collection(`${prefijo}_usuarios`).doc(uid).delete();
      setMensaje({texto:'âœ… Usuario eliminado',tipo:'ok'});
      setTimeout(()=>setMensaje({texto:'',tipo:''}),2000);
    }catch(err){
      setMensaje({texto:'âŒ '+err.message,tipo:'error'});
    }
  };

  const badgeRol=(rol)=>{
    if(rol==='admin')return{bg:'#EDE9FE',color:'#6D28D9',label:'ğŸ”‘ Admin'};
    return{bg:'#D1FAE5',color:'#065F46',label:'ğŸ“ Seguimiento'};
  };

  if(!entidad)return<div className="empty-state"><h3>Selecciona una entidad</h3></div>;

  return(
    <div>
      <div className="page-header">
        <h1>ğŸ‘¥ GestiÃ³n de Usuarios</h1>
        <button className="btn-primary" style={{width:'auto'}} onClick={()=>setModal(true)}>+ Nuevo Usuario</button>
      </div>

      {mensaje.texto&&(
        <div style={{padding:'0.75rem 1rem',borderRadius:'8px',marginBottom:'1rem',
          background:mensaje.tipo==='ok'?'#D1FAE5':'#FEE2E2',
          color:mensaje.tipo==='ok'?'#065F46':'#991B1B',fontWeight:600}}>
          {mensaje.texto}
        </div>
      )}

      {/* Tabla de usuarios */}
      <div className="card">
        <h3>Usuarios con acceso ({usuarios.length})</h3>
        {usuarios.length===0?(
          <div className="empty-state" style={{padding:'2rem'}}>
            <p>No hay usuarios registrados aÃºn</p>
          </div>
        ):(
          <table className="tabla">
            <thead>
              <tr>
                <th>Nombre / Email</th>
                <th>Rol Actual</th>
                <th>Cambiar Rol</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {usuarios.map(u=>{
                const b=badgeRol(u.rol);
                const esTu=(u.id===user.uid);
                return(
                  <tr key={u.id}>
                    <td>
                      <strong>{u.nombre||u.email}</strong>
                      {esTu&&<span style={{marginLeft:'0.5rem',fontSize:'0.75rem',color:'#6B7280'}}>(TÃº)</span>}
                      <div style={{fontSize:'0.8rem',color:'#6B7280'}}>{u.email}</div>
                    </td>
                    <td>
                      <span style={{padding:'0.25rem 0.75rem',borderRadius:'12px',fontSize:'0.8rem',
                        fontWeight:700,background:b.bg,color:b.color}}>
                        {b.label}
                      </span>
                    </td>
                    <td>
                      {!esTu&&(
                        <select
                          value={u.rol}
                          onChange={e=>cambiarRol(u.id,e.target.value)}
                          style={{padding:'0.4rem 0.5rem',borderRadius:'6px',border:'2px solid #E5E7EB',fontSize:'0.875rem'}}>
                          <option value="admin">ğŸ”‘ Admin</option>
                          <option value="seguimiento">ğŸ“ Seguimiento</option>
                        </select>
                      )}
                      {esTu&&<span style={{fontSize:'0.8rem',color:'#9CA3AF'}}>â€”</span>}
                    </td>
                    <td>
                      {!esTu&&(
                        <button className="btn-secondary"
                          style={{padding:'0.4rem 0.75rem',fontSize:'0.8rem'}}
                          onClick={()=>eliminarUsuario(u.id,u.email)}>
                          ğŸ—‘ï¸ Eliminar
                        </button>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        )}
      </div>

      {/* Info de roles */}
      <div className="grid">
        <div className="card" style={{borderLeft:'4px solid #6D28D9'}}>
          <h4>ğŸ”‘ Administrador</h4>
          <p style={{color:'#6B7280',fontSize:'0.875rem',marginTop:'0.5rem'}}>
            âœ… Crear/editar/eliminar todo<br/>
            âœ… Gestionar usuarios<br/>
            âœ… PlaneaciÃ³n, Seguimiento, POAs<br/>
            âœ… Dashboard e informes
          </p>
        </div>
        <div className="card" style={{borderLeft:'4px solid #059669'}}>
          <h4>ğŸ“ Solo Seguimiento</h4>
          <p style={{color:'#6B7280',fontSize:'0.875rem',marginTop:'0.5rem'}}>
            âœ… Registrar avances en Seguimiento<br/>
            âœ… Registrar actividades en POAs<br/>
            âœ… Ver Dashboard e informes<br/>
            ğŸ‘ï¸ Ver PlaneaciÃ³n (solo lectura)<br/>
            âŒ No puede editar estructura
          </p>
        </div>
      </div>

      {/* Modal crear usuario */}
      {modal&&(
        <div className="modal-overlay" onClick={()=>setModal(false)}>
          <div className="modal" onClick={e=>e.stopPropagation()}>
            <div className="modal-header">
              <h2>â• Crear Nuevo Usuario</h2>
              <button className="btn-cerrar" onClick={()=>setModal(false)}>Ã—</button>
            </div>
            <div className="modal-body">
              <div style={{background:'#FEF3C7',padding:'0.75rem 1rem',borderRadius:'8px',
                marginBottom:'1rem',fontSize:'0.875rem',color:'#92400E'}}>
                âš ï¸ Crea aquÃ­ las cuentas de tus colaboradores. Ellos usarÃ¡n este email y contraseÃ±a para entrar.
              </div>
              {mensaje.texto&&(
                <div style={{padding:'0.75rem',borderRadius:'8px',marginBottom:'1rem',
                  background:mensaje.tipo==='ok'?'#D1FAE5':'#FEE2E2',
                  color:mensaje.tipo==='ok'?'#065F46':'#991B1B',fontSize:'0.875rem'}}>
                  {mensaje.texto}
                </div>
              )}
              <form onSubmit={crearUsuario}>
                <div className="form-group">
                  <label>Nombre completo</label>
                  <input type="text" value={form.nombre}
                    onChange={e=>setForm({...form,nombre:e.target.value})}
                    placeholder="Ej: MarÃ­a GonzÃ¡lez"/>
                </div>
                <div className="form-group">
                  <label>Email *</label>
                  <input type="email" value={form.email}
                    onChange={e=>setForm({...form,email:e.target.value})}
                    required placeholder="usuario@correo.com"/>
                </div>
                <div className="form-group">
                  <label>ContraseÃ±a *</label>
                  <input type="password" value={form.password}
                    onChange={e=>setForm({...form,password:e.target.value})}
                    required placeholder="MÃ­nimo 6 caracteres" minLength={6}/>
                </div>
                <div className="form-group">
                  <label>Rol *</label>
                  <select value={form.rol} onChange={e=>setForm({...form,rol:e.target.value})}>
                    <option value="seguimiento">ğŸ“ Solo Seguimiento</option>
                    <option value="admin">ğŸ”‘ Administrador</option>
                  </select>
                </div>
                <button type="submit" className="btn-primary" disabled={loading}>
                  {loading?'â³ Creando...':'âœ… Crear Usuario'}
                </button>
              </form>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const ModalImpresionDashboard=({entidad,datos,anioSeleccionado,onClose})=>{
  const{ejes=[],objetivos=[],indicadores=[],seguimientos=[]}=datos||{};
  const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const hoy=new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});
  const anio=parseInt(anioSeleccionado);

  // EstadÃ­sticas generales del aÃ±o
  const segsAnio=seguimientos.filter(s=>parseInt(s.anio)===anio);
  const totalRegs=segsAnio.length;
  const optimos=segsAnio.filter(s=>s.score==='optimo').length;
  const precaucion=segsAnio.filter(s=>s.score==='precaucion').length;
  const criticos=segsAnio.filter(s=>s.score==='critico').length;
  const promAnual=totalRegs>0?Math.round(segsAnio.reduce((s,x)=>s+x.rendimiento,0)/totalRegs):0;

  const scoreClass=(s)=>s==='optimo'?'s-optimo':s==='precaucion'?'s-precaucion':'s-critico';
  const scoreLabel=(s)=>s==='optimo'?'ğŸŸ¢ Ã“ptimo':s==='precaucion'?'ğŸŸ¡ PrecauciÃ³n':'ğŸ”´ CrÃ­tico';

  return(
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" style={{maxWidth:'960px'}} onClick={e=>e.stopPropagation()}>
        <div className="modal-header">
          <h2>Informe Anual {anio} - {entidad?.nombre}</h2>
          <div style={{display:'flex',gap:'0.5rem',alignItems:'center'}}>
            <button className="btn-primary" style={{width:'auto',marginBottom:0}} onClick={()=>window.print()}>ğŸ–¨ï¸ Imprimir / PDF</button>
            <button className="btn-cerrar" onClick={onClose}>Ã—</button>
          </div>
        </div>
        <div className="modal-body informe-dashboard">
          <h1>Informe de Seguimiento Anual {anio}</h1>
          <div className="entidad-info">
            <strong>{entidad?.nombre}</strong> &nbsp;|&nbsp;
            NIT: {entidad?.nit} &nbsp;|&nbsp;
            Periodo: {entidad?.periodo} &nbsp;|&nbsp;
            Fecha: {hoy}
          </div>

          {/* Resumen general */}
          <div className="resumen-general">
            <div className="res-item"><div className="res-val">{indicadores.length}</div><div className="res-lbl">Indicadores</div></div>
            <div className="res-item"><div className="res-val" style={{color:'#059669'}}>{optimos}</div><div className="res-lbl">Registros Ã“ptimo</div></div>
            <div className="res-item"><div className="res-val" style={{color:'#F59E0B'}}>{precaucion}</div><div className="res-lbl">PrecauciÃ³n</div></div>
            <div className="res-item"><div className="res-val" style={{color:'#DC2626'}}>{criticos}</div><div className="res-lbl">CrÃ­ticos</div></div>
          </div>

          {/* Por cada eje */}
          {ejes.map(eje=>{
            const objsEje=objetivos.filter(o=>o.ejeId===eje.id);
            const indsEje=indicadores.filter(i=>objsEje.some(o=>o.id===i.objetivoId));
            if(indsEje.length===0)return null;
            return(
              <div key={eje.id}>
                <div style={{background:eje.color||'#4F46E5',color:'white',padding:'0.5rem 1rem',borderRadius:'8px',fontWeight:'700',fontSize:'1rem',marginBottom:'0.75rem',marginTop:'1.5rem'}}>
                  ğŸ¯ {eje.nombre}
                </div>
                {indsEje.map(ind=>{
                  const obj=objetivos.find(o=>o.id===ind.objetivoId);
                  const segsInd=seguimientos.filter(s=>s.indicadorId===ind.id&&parseInt(s.anio)===anio)
                    .sort((a,b)=>meses.indexOf(a.mes)-meses.indexOf(b.mes));
                  const metaAnual=ind.metasPorAnio&&ind.metasPorAnio[anio]?ind.metasPorAnio[anio]:ind.meta;
                  const promInd=segsInd.length>0?Math.round(segsInd.reduce((s,x)=>s+x.rendimiento,0)/segsInd.length):null;
                  const scorePromedio=promInd!=null?(entidad?.scoreConfig?(promInd>=(entidad.scoreConfig.optimo?.min||86)?'optimo':promInd>=(entidad.scoreConfig.precaucion?.min||61)?'precaucion':'critico'):(promInd>=86?'optimo':promInd>=61?'precaucion':'critico')):null;

                  return(
                    <div key={ind.id} className="ind-block">
                      <div className="ind-header">
                        <div>
                          <strong>{ind.nombre}</strong>
                          <span style={{marginLeft:'0.75rem',fontSize:'0.8rem',opacity:0.85}}>{ind.tipo==='ascendente'?'ğŸ“ˆ':'ğŸ“‰'} {ind.periodicidad}</span>
                        </div>
                        <div style={{fontSize:'0.85rem',textAlign:'right'}}>
                          {segsInd.length} registro{segsInd.length!==1?'s':''}
                          {promInd!=null&&<span style={{marginLeft:'0.75rem',fontWeight:'700'}}>{promInd}% prom.</span>}
                        </div>
                      </div>
                      <div className="ind-subheader">
                        <span>ğŸ“Œ {obj?.nombre}</span>
                        <span>Meta {anio}: <strong>{metaAnual} {ind.unidad}</strong></span>
                        {ind.estrategia&&<span>ğŸ¯ {ind.estrategia}</span>}
                      </div>
                      {segsInd.length===0?(
                        <div style={{padding:'0.75rem 1rem',background:'#F9FAFB',fontSize:'0.85rem',color:'#9CA3AF',fontStyle:'italic',borderRadius:'0 0 8px 8px'}}>
                          Sin registros de seguimiento en {anio}
                        </div>
                      ):(
                        <table>
                          <thead><tr>
                            <th>Mes</th>
                            <th>Meta Anual</th>
                            <th>Meta Mes</th>
                            <th>Avance</th>
                            <th>Rendimiento</th>
                            <th>Estado</th>
                          </tr></thead>
                          <tbody>
                            {segsInd.map(seg=>(
                              <tr key={seg.id}>
                                <td><strong>{seg.mes}</strong></td>
                                <td>{seg.metaAnual||metaAnual} {ind.unidad}</td>
                                <td>{seg.metaMes} {ind.unidad}</td>
                                <td>{seg.avance} {ind.unidad}</td>
                                <td>
                                  <strong>{seg.rendimiento.toFixed(1)}%</strong>
                                  <span className="barra-avance"><span className="barra-fill" style={{width:`${Math.min(100,seg.rendimiento)}%`,background:seg.score==='optimo'?'#059669':seg.score==='precaucion'?'#F59E0B':'#DC2626'}}></span></span>
                                </td>
                                <td className={scoreClass(seg.score)}>{scoreLabel(seg.score)}</td>
                              </tr>
                            ))}
                            {segsInd.length>1&&(
                              <tr className="fila-total">
                                <td>PROMEDIO {anio}</td>
                                <td>{metaAnual} {ind.unidad}</td>
                                <td>â€”</td>
                                <td>â€”</td>
                                <td><strong>{promInd}%</strong></td>
                                <td className={scoreClass(scorePromedio)}>{scoreLabel(scorePromedio)}</td>
                              </tr>
                            )}
                          </tbody>
                        </table>
                      )}
                    </div>
                  );
                })}
              </div>
            );
          })}
          <div style={{marginTop:'2rem',borderTop:'1px solid #E5E7EB',paddingTop:'1rem',fontSize:'0.8rem',color:'#9CA3AF',textAlign:'center'}}>
            {entidad?.nombre} Â· PlaneaciÃ³n EstratÃ©gica {entidad?.periodo} Â· Generado el {hoy}
          </div>
        </div>
      </div>
    </div>
  );
};

const ModalImpresionPlaneacion=({entidad,datos,onClose})=>{
  const{ejes=[],objetivos=[],indicadores=[]}=datos||{};
  const hoy=new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});
  return(
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" style={{maxWidth:'900px'}} onClick={e=>e.stopPropagation()}>
        <div className="modal-header">
          <h2>Vista Previa - PlaneaciÃ³n EstratÃ©gica</h2>
          <div style={{display:'flex',gap:'0.5rem'}}>
            <button className="btn-primary" style={{width:'auto',marginBottom:0}} onClick={()=>window.print()}>ğŸ–¨ï¸ Imprimir / Guardar PDF</button>
            <button className="btn-cerrar" onClick={onClose}>Ã—</button>
          </div>
        </div>
        <div className="modal-body informe-print" id="informe-planeacion">
          <h1>PlaneaciÃ³n EstratÃ©gica - {entidad?.nombre}</h1>
          <div className="entidad-info">
            <strong>NIT:</strong> {entidad?.nit} &nbsp;|&nbsp;
            <strong>Periodo:</strong> {entidad?.periodo} &nbsp;|&nbsp;
            <strong>Fecha de impresiÃ³n:</strong> {hoy}
          </div>
          {entidad?.vision&&<div style={{background:'#EEF2FF',padding:'0.75rem 1rem',borderRadius:'8px',marginBottom:'1.5rem',fontSize:'0.9rem',color:'#4F46E5',borderLeft:'4px solid #4F46E5'}}><strong>VisiÃ³n:</strong> {entidad.vision}</div>}

          {ejes.map(eje=>{
            const objsEje=objetivos.filter(o=>o.ejeId===eje.id);
            const indsEje=indicadores.filter(i=>objsEje.some(o=>o.id===i.objetivoId));
            if(objsEje.length===0&&indsEje.length===0)return null;
            return(
              <div key={eje.id} className="eje-block">
                <div className="eje-titulo" style={{background:eje.color||'#4F46E5'}}>
                  ğŸ¯ {eje.nombre} &nbsp;<span style={{fontSize:'0.8rem',opacity:0.8}}>({indsEje.length} indicador{indsEje.length!==1?'es':''})</span>
                </div>
                {objsEje.map(obj=>{
                  const indsObj=indicadores.filter(i=>i.objetivoId===obj.id);
                  return(
                    <div key={obj.id} className="objetivo-block">
                      <div className="objetivo-titulo">ğŸ“Œ {obj.nombre}</div>
                      {indsObj.length>0&&(
                        <>
                        <div className="header-cols">
                          <span>Indicador</span>
                          <span>Meta Base</span>
                          <span>Metas por AÃ±o</span>
                        </div>
                        {indsObj.map(ind=>(
                          <div key={ind.id} className="indicador-row">
                            <div className="indicador-nombre">
                              {ind.nombre}
                              <span className={`badge-tipo ${ind.tipo==='ascendente'?'asc':'desc'}`}>
                                {ind.tipo==='ascendente'?'ğŸ“ˆ Asc':'ğŸ“‰ Des'}
                              </span>
                              <div style={{fontSize:'0.75rem',color:'#6B7280',marginTop:'0.2rem'}}>{ind.periodicidad}</div>
                            </div>
                            <div className="indicador-meta">{ind.meta} {ind.unidad}</div>
                            <div className="indicador-anios">
                              {ind.metasPorAnio&&Object.keys(ind.metasPorAnio).length>0
                                ?Object.entries(ind.metasPorAnio).map(([a,m])=>(
                                  <span key={a} style={{display:'inline-block',background:'#EEF2FF',color:'#4F46E5',padding:'0.1rem 0.4rem',borderRadius:'4px',fontSize:'0.75rem',marginRight:'0.3rem',marginBottom:'0.2rem',fontWeight:600}}>
                                    {a}: {m} {ind.unidad}
                                  </span>
                                ))
                                :<span style={{color:'#9CA3AF',fontStyle:'italic'}}>Sin metas especÃ­ficas</span>
                              }
                              {ind.estrategia&&<div style={{marginTop:'0.25rem',fontStyle:'italic',color:'#6B7280'}}>ğŸ¯ {ind.estrategia}</div>}
                            </div>
                          </div>
                        ))}
                        </>
                      )}
                      {indsObj.length===0&&<p style={{color:'#9CA3AF',fontSize:'0.8rem',fontStyle:'italic',paddingLeft:'0.5rem'}}>Sin indicadores</p>}
                    </div>
                  );
                })}
              </div>
            );
          })}
          <div style={{marginTop:'2rem',borderTop:'1px solid #E5E7EB',paddingTop:'1rem',fontSize:'0.8rem',color:'#9CA3AF',textAlign:'center'}}>
            Total: {ejes.length} ejes | {objetivos.length} objetivos | {indicadores.length} indicadores
          </div>
        </div>
      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
